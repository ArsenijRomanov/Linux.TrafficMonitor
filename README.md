# Traffic Monitor — обнаружение и блокировка подозрительного трафика

Приложение для Linux на Python, которое в реальном времени перехватывает сетевые пакеты, определяет подозрительную активность по простым правилам и позволяет **блокировать/разблокировать источники** средствами **iptables**.

---

## Возможности

- **Мониторинг трафика в реальном времени** (перехват пакетов через Scapy).
- **Агрегация статистики по источникам:**
  - суммарный объём трафика (байты/KB);
  - количество **уникальных портов назначения**.
- **Выявление подозрительных источников** по двум правилам:
  - превышение порога по суммарному объёму трафика;
  - превышение порога по числу уникальных портов.
- **Блокировка/разблокировка IP** через iptables.
- **Корректная остановка захвата пакетов** без перезапуска приложения.
- **Логирование событий** в файл `logs/network_monitor.log`.
- Защита от «самоблокировки»: приложение **не позволяет блокировать**
  - все собственные IPv4‑адреса хоста,
  - шлюз по умолчанию.

---

## Как работает

1. При нажатии **Start Monitor** запускается перехват пакетов.
2. По каждому IP адресу, отправляющему пакеты на хост с запущенным монитором, собирается статистика.
3. При превышении порогов источник отображается в списке **Suspicious** с причиной и показателями (KB и Ports).
4. Пользователь может выбрать IP и нажать **Block Selected IP** — будет добавлено правило iptables.
5. Выбранный адрес можно снять с блокировки через **Unblock Selected IP**.
6. **Stop Monitor** останавливает захват пакетов.

---

## Требования

- **Linux** с доступными утилитами: `iptables`, `ip`.
- **Python 3.10+**.
- Права администратора для захвата трафика и управления iptables.

Зависимости Python:
- `scapy`
- `tkinter` (обычно идёт вместе с Python; на некоторых дистрибутивах требуется пакет `python3-tk`)

---

## Запуск

Запустить приложение с повышенными правами:

```bash
sudo python3 traffic_monitor.py
```

---

## Использование

- **Start Monitor** — начать перехват пакетов.
- **Packet Log** (левая таблица) — поток пакетов (Source IP, Port, Size).
- **Suspicious** (средняя таблица) — IP‑адреса, которые превысили пороги:
  - **Reason**: причина (Traffic Limit / Port Scanning)
  - **Total (KB)**: суммарный трафик
  - **Ports**: число уникальных портов назначения
- **Block Selected IP** — добавить iptables‑правило и переместить адрес в **Blocked**.
- **Unblock Selected IP** — удалить iptables‑правило.
- **Stop Monitor** — остановить захват.

---

## Настройка порогов

Пороги задаются в `traffic_monitor.py`:

```python
SIZE_THR = 10240      # байт
PORT_SCAN_THR = 5     # уникальных портов
```

---

## Логи

Логи пишутся в файл:

- `logs/network_monitor.log`

Фиксируются ключевые события:
- старт/остановка мониторинга;
- обнаружение подозрительных источников;
- блокировка/разблокировка;
- ошибки выполнения системных команд.

---

## Проверка блокировок через терминал

Показать правила цепочки INPUT с нумерацией:

```bash
sudo iptables -L INPUT -n --line-numbers
```

Показать правила с счётчиками пакетов/байт:

```bash
sudo iptables -L INPUT -n -v --line-numbers
```

После блокировки выбранного IP вы увидите правило вида `REJECT` для соответствующего `source`.

---

## Разблокировка вручную
### Если требуется удалить правило без запуска приложения:

1) Найдите номер правила:

```bash
sudo iptables -L INPUT -n --line-numbers
```

2) Удалите по номеру (пример: правило №1):

```bash
sudo iptables -D INPUT <num>
```

---

## Файлы проекта

- `traffic_monitor.py` — основная программа.
- `logs/network_monitor.log` — журнал (создаётся автоматически при запуске).

---
